---
package:
    name: rootfs-core
    description: Root file system for core components
    version: 0.0.1
    dependencies:
        - glibc
        - gcc
        - zlib
        - xz
        - attr
        - libcap
        - libseccomp
        - libapparmor
        - libnih
        - json-c
        - protobuf
        - protobuf-c
        - expat
        - db
        - bash
        - dbus
        - openssl
        - busybox
        - iproute2
        - dnsmasq
        - upstart
        - e2fsprogs
        - squashfs
        - syslinux
        - lxc
        - criu
        - redis
        - nodejs
        - node-evo-cloud
        - tc-squashfs
        - rootfs-base
        - rootfs-boot

build:
    - script: |
        set -e
        
        mkdir -p $_RELDIR/root/lib64
        
        for dep in $_PKGDEPS ; do
            [ "${dep#tc-}" == "$dep" ] && \
            [ "${dep#rootfs-}" == "$dep" ] && \
            cp -a $_RELBASE/$dep/rel/* $_RELDIR/root/
        done
        
        rm -fr $_RELDIR/root/lib32
        
        rm -f $_RELDIR/root/etc/init/*.conf
        cp -a $_RELBASE/$_DEP_ROOTFS_BOOT/root/* $_RELDIR/root/

    - scripts:
        root.sh: |
            set -e
            tar -C $_RELDIR/root -xf $_RELBASE/$_DEP_ROOTFS_BASE/rootfs.tar
            
            # fix /lib as 64-bit system uses /lib64
            mv -f $_RELDIR/root/lib/* $_RELDIR/root/lib64/
            rmdir $_RELDIR/root/lib
            ln -s lib64 $_RELDIR/root/lib
            
            # make a /usr link
            ln -s / $_RELDIR/root/usr
            
            $_RELBASE/$_DEP_TC_SQUASHFS/mksquashfs $_RELDIR/root $_RELDIR/rootfs.squashfs -comp xz -no-xattrs -all-root -noappend -no-progress
      commands:
        - fakeroot $SHELL $_BLDDIR/root.sh