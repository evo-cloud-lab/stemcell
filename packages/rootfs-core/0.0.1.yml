---
package:
    name: rootfs-core
    description: Root file system for core components
    version: 0.0.1
    dependencies:
        - glibc
        - gcc
        - zlib
        - xz
        - attr
        - libcap
        - libseccomp
        - libapparmor
        - libnih
        - json-c
        - expat
        - dbus
        - openssl
        - openssh
        - busybox
        - upstart
        - e2fsprogs
        - squashfs
        - syslinux
        - lxc
        - redis
        - nodejs
        - node-pm2
        - bash
        - tc-squashfs
        - basefs

build:
    - script: |
        set -e
        
        mkdir -p $_RELDIR/root/lib64
        
        for dep in $_PKGDEPS ; do
            [ "${dep#tc-}" == "$dep" ] && \
            [ "${dep#basefs-}" == "$dep" ] && \
            cp -a $_RELBASE/$dep/rel/* $_RELDIR/root/
        done
        
        rm -fr $_RELDIR/root/lib32
        
        rm -f $_RELDIR/root/etc/init/*.conf
        cp -a $_RELBASE/$_DEP_BASEFS/etc $_RELDIR/root/

    - scripts:
        root.sh: |
            set -e
            tar -C $_RELDIR/root -xf $_RELBASE/$_DEP_BASEFS/rootfs.tar
            
            # fix /lib as 64-bit system uses /lib64
            mv -f $_RELDIR/root/lib/* $_RELDIR/root/lib64/
            rmdir $_RELDIR/root/lib
            ln -s lib64 $_RELDIR/root/lib
            
            $_RELBASE/$_DEP_TC_SQUASHFS/mksquashfs $_RELDIR/root $_RELDIR/rootfs.squashfs -comp xz -no-xattrs -all-root -noappend -no-progress
      commands:
        - fakeroot $SHELL $_BLDDIR/root.sh