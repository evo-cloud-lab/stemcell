---
package:
    name: basefs
    description: Base file system layout
    version: 0.0.1

sources:
    - file: startup.sh
      packaged: true

    - file: startup.conf
      packaged: true
      
    - file: network-init.conf
      packaged: true
    
    - file: network-init.sh
      packaged: true
    
    - file: console.conf
      packaged: true

    - file: tty1.conf
      packaged: true
    
    - file: tty2.conf
      packaged: true
    
    - file: tty3.conf
      packaged: true

    - file: udhcpc-script.sh
      packaged: true

    - file: passwd.txt
      packaged: true
    
    - file: group.txt
      packaged: true
      
    - file: banner.txt
      packaged: true
    
    - file: issue.txt
      packaged: true

build:
    - commands:
        - for d in dev mnt proc sys var tmp ; do mkdir -p $_RELDIR/root/$d ; done
        - mkdir -p $_RELDIR/root/lib/modules
        - mkdir -p $_RELDIR/root/lib/firmware
        # create etc template
        - mkdir -p $_RELDIR/etc/init
        - mkdir -p $_RELDIR/etc/scripts
        # create init script and services
        - cp $_PKGDIR/*.conf $_RELDIR/etc/init/
        - cp $_PKGDIR/*.sh $_RELDIR/etc/scripts/
        - chmod a+rx $_RELDIR/etc/scripts/*.sh
        # other files
        - cp $_PKGDIR/banner.txt $_RELDIR/etc/banner
        - cp $_PKGDIR/issue.txt $_RELDIR/etc/issue
        - cp $_PKGDIR/passwd.txt $_RELDIR/etc/passwd
        - cp $_PKGDIR/group.txt $_RELDIR/etc/group

    - scripts:
        root.sh: |
            for n in \
                666,tty,c,5,0                   \
                622,console,c,5,1               \
                666,ptmx,c,5,2                  \
                620,mem,c,1,1                   \
                622,ram0,b,1,0                  \
                622,ram1,b,1,1                  \
                666,null,c,1,3                  \
                666,zero,c,1,5                  \
                666,full,c,1,7                  \
                666,random,c,1,8                \
                666,urandom,c,1,9               \
                600,kmsg,c,1,11                 \
                660,tty0,c,4,0                  \
                660,tty1,c,4,1                  \
                660,tty2,c,4,2                  \
                660,tty3,c,4,3                  \
                600,loop-control,c,10,237       \
                660,loop0,b,7,0                 \
                660,loop1,b,7,1                 \
                660,loop2,b,7,2                 \
                660,loop3,b,7,3                 \
                660,sr0,b,11,0
            do
                eval mknod `echo $n | sed "s/,/ /g" | sed -r "s!^([[:digit:]]+)[[:space:]]!-m \\1 $_RELDIR/root/dev/!"`
            done
            mkdir -m 755 $_RELDIR/root/dev/pts
            mkdir -m 755 $_RELDIR/root/dev/mapper
            tar -C $_RELDIR/root -cf $_RELDIR/rootfs.tar .
      commands:
        - fakeroot $SHELL $_BLDDIR/root.sh